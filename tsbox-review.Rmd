---
title: "tsbox review"
author: "nunesmatt"
date: "29/09/2022"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Package Review

*Please check off boxes as applicable, and elaborate in comments below.  Your review is not limited to these topics, as described in the reviewer guide*

- **Briefly describe any working relationship you have (had) with the package authors.**
- [X] As the reviewer I confirm that there are no [conflicts of interest](https://devguide.ropensci.org/policies.html#coi) for me to review this work (if you are unsure whether you are in conflict, please speak to your editor _before_ starting your review).

#### Documentation

The package includes all the following forms of documentation:

- [X] **A statement of need:** clearly stating problems the software is designed to solve and its target audience in README
- [X] **Installation instructions:** for the development version of package and any non-standard dependencies in README
- [X] **Vignette(s):** demonstrating major functionality that runs successfully locally
- [X] **Function Documentation:** for all exported functions
- [X] **Examples:** (that run successfully locally) for all exported functions
- [X] **Community guidelines:** including contribution guidelines in the README or CONTRIBUTING, and DESCRIPTION with `URL`, `BugReports` and `Maintainer` (which may be autogenerated via `Authors@R`).

#### Functionality

- [X] **Installation:** Installation succeeds as documented.
- [X] **Functionality:** Any functional claims of the software been confirmed.
- [X] **Performance:** Any performance claims of the software been confirmed.
- [X] **Automated tests:** Unit tests cover essential functions of the package and a reasonable range of inputs and conditions. All tests pass on the local machine.
- [X] **Packaging guidelines**: The package conforms to the rOpenSci packaging guidelines.
Estimated hours spent reviewing: 7

- [X] Should the author(s) deem it appropriate, I agree to be acknowledged as a package reviewer ("rev" role) in the package DESCRIPTION file.

---

### Review Comments

Thank you for thinking of me to review this package (this is my first ROpenSci review).  Please find some comments on the package below.  The full script of this review can be found at my github page on this [tsbox review](https://github.com/nunesmatt/tsbox-review).

**Summary**

The package aims to supply a structure/class-agnostic approach to time series analysis to circumvent some of the arguably tedious user conversion between classes before analysis tasks.  In doing so, the 
functionality aims at generality -- I feel this is a useful package in terms of functionality and scope for a wide range of end-users.  The package is well-documented and the three vignettes all run smoothly. 

Some comments on the package are below.  Note that these are suggestions rather than fixes per se: 

1.  **Package checking**. When checking the package, I get:

```
dts_first_of_period: no visible binding for global variable ‘time.orig’
## Undefined global functions or variables:
##   time.orig
```

Whilst this is not an error, one suggestion might be to define `time.orig` as `NULL` (like is done for `has.value`) at the start of the function or before the subsetting in the `dts_first_of_period` function (contained within `ts_first_of_period.R`).

2. **good practice**.  A few things came up when using `gp`.  Many code lines come up as 81 characters (as opposed to suggested lengths of $\leq 80$), which might be due to line endings etc.  `guess_dts.R` has a suggestion of using `vapply` rather than `sapply`.  These are left to the developer to tackle if desired. 

3. **Error message about `ts_boxable(x)`**.  I wonder whether a more informative error message could be shown when `ts_boxable(x)` is not `TRUE`.  For example, whilst I realise that the package is designed for existing time series classes, using a `tsbox` function on a vector or inappropriate object results in the error, but the user may not know how to fix the issue, especially as `ts_boxable()` is primarily internal. Perhaps the message could point to the expected structure of the argument of the main package functions, e.g. "... please ensure the object `x` has components..." or "Is the object of class x, y or z?"

4.  **Comparison with `timetk`**. During playing with this package, I mainly focussed on the conversion functions (`ts_tbl()`, `ts_long()`,`ts_ts()`etc), as, whilst delving into testing datasets, I came across the `timetk` package, which at first glance aims to do a similar job to `tsbox`.  

All functions in `tsbox` worked as expected, and some arguably have a more natural output than `timetk` (see full review document). 

The package developer might want to consider an additional function handling the `zooreg` class for completeness.

5.  Whilst users are probably familiar with usage, the developer might want to consider adding examples to show functionality of `ts_prcomp` and `ts_forecast` under the `ts_examples` documentation file.

6.  I noticed that there is a spelling mistake of *explicit* in the error messages for the `guess_time` and `guess_value` functions.

Full script for checking the package is below.

```{r}
# some setup
library(devtools)
install_github("christophsax/tsbox")
library(tsbox)

# create local version too
library(gert)
gert::git_clone("https://github.com/christophsax/tsbox", path = "./tsbox-temp")

sessionInfo()
```

## Package infrastructure

checking and testing the package
```{r}
library(devtools)
devtools::check("./tsbox-temp")

devtools::test("./tsbox-temp")
```

and now with `goodpractice` eyes... 
```{r, eval = FALSE}
library(goodpractice)
gp("./tsbox-temp")
```

## Functionality

### Some initial stuff
idiot-proofing and checking issues raised by previous reviewer @chamberlink 
```{r, eval = TRUE}
# messages for idiot-proofing

# create *vector* rather than ts
mynonts = sin((1:256)/pi) + rnorm(256) 

try(ts_xts(mynonts))

# check previous reviewer comments

library(tibble)
Conn_discharge_DO <- tibble(
  agency_cd = c("USGS", "USGS", "USGS", "USGS"),
  site_no = c("01193050", "01193050", "01193050", "01193050"),
  dateTime = as.POSIXct(c("2019-01-01 05:00:00", "2019-01-01 05:15:00", "2019-01-01 05:30:00", "2019-01-01 05:45:00")),
  unit = "ft3/s",
  X_00060_00000 = 1:4,
  noDataValue = NA,
  X_00060_000002 = 11:14,
  X_00060_00000_cd = "A"
)

ts_xts(Conn_discharge_DO)

ts_long(Conn_discharge_DO)

Eno_discharge <- dataRetrieval::readNWISuv(siteNumbers = "02085070",
   parameterCd = "00060",
   startDate = "2019-01-01",
   endDate = "2021-01-01"
 )

ts_plot(Eno_discharge)

## check on daisy-chaining
library(astsa)
data(AirPassengers)
ts_plot(ts_forecast(AirPassengers))

## check on multivariate series
library(datasets)
data("EuStockMarkets")
ts_plot(EuStockMarkets)
head(ts_prcomp(EuStockMarkets))
```

compare functionality / output with `timetk` package see the [vignette](https://business-science.github.io/timetk/articles/TK00_Time_Series_Coercion.html).

```{r}
library(tsbox)
library(timetk)
library(tidyverse)

q10_quarterly <- m4_quarterly %>% filter(id == "Q10")

# create "usual" time series object
q10_quarterly_ts <- ts(q10_quarterly$value, start = c(2000, 1), freq  = 4)

# tsbox has a more natural interpretation of the "raw" data (without the start / freq information); timetk needs extra info
q10_quarterly_ts_timetk <- tk_ts(q10_quarterly, start = 2000, freq  = 4)

tk_ts(q10_quarterly)  # not ok
ts_ts(q10_quarterly)  # ok

# check current tsbox ts wrapping
ts_long(m4_quarterly)
head(ts_xts(m4_quarterly))
head(ts_zoo(m4_quarterly))

# check to <-> from conversion

# tbl -> ts -> tbl
# as expected due to the time indexing

ts_tbl(ts_ts(q10_quarterly))

# tbl -> xts -> tbl
# as expected due to the time indexing

ts_tbl(ts_xts(q10_quarterly))

# tbl -> xts -> long -> tbl
# as expected due to the time indexing
ts_tbl(ts_long(ts_xts(q10_quarterly)))
```

### a minor something else
```{r}
try(tsbox:::guess_time(as.data.frame(x=runif(10))))

try(tsbox:::guess_value(as.data.frame(x=LETTERS[1:10])))
```